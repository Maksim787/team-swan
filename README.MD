# team-swan

## Структура кода

Весь код, который обучает модели, находится в папке `pipeline/`

В нем следующие файлы:

1. `constants.py` — объявление числа классов (`N_CLASSES`) и девайса для обучения (`device`)
1. `criterions.py` — объявление loss-функций. Пока там объявлена только CrossEntropyLoss и матрица SCORE_MATRIX, которая используется для оценки жюри
1. `loader.py` — содержит `SwanDataset`, а также функцию `get_dataloaders`, которая возвращает `DataLoader`-ы для тренировочной и тестовой выборки
1. `train_utils.py` — функции для обучения нейросети (train loop)
1. `models/` — объявление моделей, которые можно обучать

Пример использования всего кода в `train.ipynb`. В этом файле полностью прописано обучение

### `loader.py`

`SwanDataset` Имеет следующие фичи:

- Делит выборку на тренировочную и тестовую, сохраняя баланс классов
- Применяет трансформации к выборке и сохраняет полученные тензоры

Особенность выборки заключается в том, что все фотографии разного размера. Для того, чтобы их привести в один формат, применяются трансформации. Результат трансформаций сохраняется в папку `cache/`, чтобы потом можно было не применять трансформации снова. Это очень важно, потому что исходные фотографии высокого разрешения, а мы работаем с фотографиями меньшего размера.

Пример расположения данных по папкам:

- `data/` — путь к этой папке нужно передать в `SwanDataset`
  - `cache/` — эту папку создаст `SwanDataset`. В ней будут храниться преобразованные изображения.
  - `klikun`
  - `разметка_малый`
  - `разметка_шипун`

Стоит обратить внимание, что изображения хранятся в папке `images` внутри. Однако, для папки `разметка_шипун` внутри папки `images` в исходной выборке есть лишняя папка `masks`, которую необходимо удалить, чтобы не было ошибок.

В `train.ipynb` в качестве трансформаций используются подряд:

1. `Expand` — паддинг нулями до квадрата
1. `Resize` — переводит в нужный размер `TARGET_SIZE`

### `train_utils.py`

Основная функция — `train_nn`. Внутри нее зовутся следующие функции:

- train_loop — цикл обучения сети
- val_loop — цикл валидации сети
- plot_results — отрисовка графиков:
  - loss
  - accuracy
  - отдельно accuracy по каждому классу
  - матрица ошибок
  - матрица score, который мы получили за предсказания в каждом квадрате матрицы ошибок. Общий score считается как сумма всех ячеек

### `models.py`

В каждом файле свои модели. Доступ к моделям осуществляется с помощью функций `get_...`, которые создают модель и возвращают ее.
Опробованные модели:

- `lenet.py` — две самописные сети `LeNet32` и `LeNet128` для разного размера входа. Выдают accuracy около 60%.
- `mobilenet.py` — MobileNet. Предобученная сеть выдает accuracy около 88%.
- `resnet.py` — ResNet18 и ResNet152. Первый выдает accuracy 90%, второй accuracy 91%.
